{
	"name": "Testing 2",
	"properties": {
		"folder": {
			"name": "Testing"
		},
		"content": {
			"query": "\tDECLARE \n\t\t@MaxMemberId\t\t\tINT \n\t,\t@MaxMemberDetailId\t\tINT\n\t,\t@MaxFactClaimDetailId\tINT\n\t,\t@ClaimType\t\t\t\tVARCHAR(50) = 'Reimbursement'\n\t\t\n\tSELECT @MaxMemberId = MAX(D.Member_Id) FROM DimMembers D WHERE D.IsExternalTPA = 1\n\tSELECT @MaxMemberDetailId = MAX(D.Member_Detail_Id) FROM DimMemberDetails D WHERE D.IsExternalTPA = 1\n\tSELECT @MaxFactClaimDetailId = MAX(D.MemberDetailId) FROM FactClaimDetails D WHERE D.IsExternalTPAClaim = 1\n\n\n\tSELECT @MaxMemberId = CASE WHEN @MaxMemberId IS NULL THEN 100000 ELSE @MaxMemberId+1 END\n\tSELECT @MaxMemberDetailId = CASE WHEN @MaxMemberDetailId IS NULL THEN 1000000 ELSE @MaxMemberDetailId+1 END\n\tSELECT @MaxFactClaimDetailId = CASE WHEN @MaxFactClaimDetailId IS NULL THEN 1000000 ELSE @MaxFactClaimDetailId+1 END\n\t\t\n\t\t\n\tDECLARE @s NVARCHAR(max);\n    DECLARE @s1 NVARCHAR(max);\n\n\t\tset @s = N'\n\t\t\t   \n\t\tCREATE TABLE #DimMembers\n\t\t(\n\t\t\tMember_id\t\tINT IDENTITY('+CONVERT(NVARCHAR,@MaxMemberId)+',1)\n\t\t,\tMember_Code\t\tVARCHAR(200)\n\t\t,\tFirst_Name\t\tVARCHAR(200)\n\t\t,\tDate_Birth\t\tDATETIME\n\t\t,\tFullMemberName\tVARCHAR(200)\n\t\t)\n\t\t\n\t\tINSERT INTO #DimMembers\n\t\t(\n\t\t\tMember_Code\n\t\t,\tFirst_Name\n\t\t,\tDate_Birth\n\t\t,\tFullMemberName\n\t\t)\n\t\tSELECT DISTINCT\n\t\t\n\t\t\tE.Member_ID\n\t\t,\tE.INSURED_NAME\n\t\t,\tDATEADD(yy,-CONVERT(INT,E.Age),GETDATE())\t \n\t\t,\tE.INSURED_NAME\t\n\n\t\tFROM load.ExternalTPAData E\n\t\tLEFT OUTER JOIN DimMembers M ON M.Member_Code = E.Member_ID AND M.IsExternalTPA = 1\n\t\tWHERE\n\t\t\tM.Member_Code IS NULL\n\t\t\t\n\t\tINSERT INTO DimMembers\n\t\t(\t\n\t\t\tMember_Id\n\t\t,\tMember_Code\n\t\t,\tFirst_Name\n\t\t,\tDate_Birth\n\t\t,\tFullMemberName\n\t\t,\tIsExternalTPA\n\t\t)\n\t\tSELECT \n\t\t\tMember_Id\n\t\t,\tMember_Code\n\t\t,\tFirst_Name\n\t\t,\tDate_Birth\n\t\t,\tFullMemberName\n\t\t,\t1\n\n\t\tFROM #DimMembers\t\n\n\t\tCREATE TABLE #DimMemberDetails\n\t\t(\n\t\t\tMember_Detail_id\t\tINT IDENTITY('+CONVERT(NVARCHAR,@MaxMemberDetailId)+',1)\n\t\t,\tMember_Id\t\t\t\tINT\n\t\t,\tStart_effective_date\tDATETIME\n\t\t,\tEnd_effective_Date\t\tDATETIME\n\t\t,\tEmployer_id\t\t\t\tINT\n\t\t,\tProductTypeId\t\t\tINT\n\t\t,\tCity\t\t\t\t\tVARCHAR(200)\n\t\t,\tState\t\t\t\t\tVARCHAR(200)\n\t\t,\tMember_code_tmp\t\t\tVARCHAR(200)\n\t\t,\tAccountNo\t\t\t\tVARCHAR(200)\n\t\t,\tBank_Code\t\t\t\tVARCHAR(200)\n\t\t,\tPolicyType\t\t\t\tVARCHAR(200)\n\t\t,\tProductId\t\t\t\tINT\n\t\t,\tPolicyNo\t\t\t\tVARCHAR(200)\n\t\t,\tSumInsured\t\t\t\tDECIMAL(19,2)\n\t\t,\tPremium\t\t\t\t\tDECIMAL(19,2)\n\t\t,\tRelationId\t\t\t\tINT\n\t\t,\tPlanId\t\t\t\t\tINT\n\t\t,\tEmployeeNo\t\t\t\tVARCHAR(200)\n\t\t,\tMember_insurer_Id\t\tINT\t\n\t\t,\tCountry\t\t\t\t\tINT\n\t\t,\tPolicy_from_date\t\tDATETIME\n\t\t,\tPolicy_to_date\t\t\tDATETIME\t\n\t\t,\tContractId\t\t\t\tINT\n\t\t)\n\t\t\n\t\tINSERT INTO #DimMemberDetails\n\t\t(\n\t\t\tMember_Id\n\t\t,\tStart_effective_date\n\t\t,\tEnd_effective_Date\n\t\t,\tEmployer_id\t\t \n\t\t,\tCity\n\t\t,\tState\n\t\t,\tMember_code_tmp\n\t\t,\tAccountNo\n\t\t,\tPolicyNo\n\t\t,\tRelationId\n\t\t,\tEmployeeNo\n\t\t,\tPolicy_from_date\n\t\t,\tPolicy_to_date\n\t\t)\n\t\tSELECT DISTINCT\n\t\t\tM.Member_Id\n\t\t,\tCONVERT(DATETIME,LEFT(E.[Policy_start_ date],10))\n\t\t,\tCONVERT(DATETIME,LEFT(E.Policy_end_date,10))\n\t\t,\tEm.EmployerId \n\t\t,\tE.[Payee City]\n\t\t,\tE.[Payee State]\n\t\t,\tE.[Member_ID]\n\t\t,\tE.PAYEE_ACCT\n\t\t,\tE.[POLICY_NO]\n\t\t,\tR.[RelationshipCode]\n\t\t,\tE.[Employee_No]\n\t\t,\tCONVERT(DATETIME,LEFT(E.[Policy_start_ date],10))\n\t\t,\tCONVERT(DATETIME,LEFT(E.[Policy_end_date],10))\n\t\t\t\n\t\tFROM Load.ExternalTPAData E\n\t\tINNER JOIN DimMembers M ON M.Member_Code = E.Member_ID AND M.IsExternalTPA = 1\n\t\tLEFT OUTER JOIN DimMemberDetails MD ON M.Member_Id = MD.Member_ID AND MD.PolicyNo = E.POLICY_NO AND MD.IsExternalTPA = 1\n\t\tLEFT OUTER JOIN DimEmployers Em ON Em.EmployerName = E.[Group name]\n\t\tINNER JOIN DIMRelationship R ON R.Description = E.[Consolidated Relation]\n\t\tWHERE\n\t\t\tMD.Member_detail_id IS NULL\n\n \t\t\n\t\tINSERT INTO DimMemberDetails\n\t\t(\n\t\t\tMember_detail_id\n\t\t,\tMember_Id\n\t\t,\tStart_effective_date\n\t\t,\tEnd_effective_Date\n\t\t,\tEmployer_id\t\t \n\t\t,\tCity\n\t\t,\tState\n\t\t,\tMember_code_tmp\n\t\t,\tAccountNo\n\t\t,\tPolicyNo\n\t\t,\tRelationshipID\n\t\t,\tEmployee_No\n\t\t,\tPolicy_from_date\n\t\t,\tPolicy_to_date\n\t\t,\tIsExternalTPA\n\t\t)\n\t\tSELECT DISTINCT\n\t\t\tMember_detail_id\n\t\t,\tMember_Id\n\t\t,\tStart_effective_date\n\t\t,\tEnd_effective_Date\n\t\t,\tEmployer_id\t\t \n\t\t,\tCity\n\t\t,\tState\n\t\t,\tMember_code_tmp\n\t\t,\tAccountNo\n\t\t,\tPolicyNo\n\t\t,\tRelationId\n\t\t,\tEmployeeNo\n\t\t,\tPolicy_from_date\n\t\t,\tPolicy_to_date\n\t\t,\t1\n\t\t\n\t\tFROM #DimMemberDetails MD\n\t\t'\nset @s1 = N'CREATE TABLE #FactClaimDetails\n\t\t(\n\t\t\t[ClaimFormDetailId] [int] IDENTITY('+CONVERT(NVARCHAR,@MaxFactClaimDetailId)+',1) ,\n\t\t\t--[ClaimFormDetailId] [int] IDENTITY(1000000,1) ,\n\t\t\t[ClaimFIRNo] [varchar](50) NULL,\n\t\t\t[ClaimType] [bit] NULL,\n\t\t\t[AmountBilled] [money] NULL,\n\t\t\t[AmountNet] [money] NULL,\n\t\t\t[AmountPaid] [money] NULL,\n\t\t\t[HospitalId] [int] NULL,\n\t\t\t[ClaimStatusId] [int] NULL,\n\t\t\t[DatePaid] [datetime] NULL,\n\t\t\t--[DateReceived] [datetime] NULL,\n\t\t\t[DateofAdmit] [datetime] NULL,\n\t\t\t[DateofDocumentation] [datetime] NULL,\n\t\t\t[DateofDischarge] [datetime] NULL,\n\t\t\t[DateModified] [datetime] NULL,\n\t\t\t[MemberDetailId] [int] NULL,\n\t\t\t[Diagnosis]\t[varchar](200) NULL, \n\t\t\t[Procedure]\t[varchar](200) NULL,\n\t\t\t[Corporate] [varchar](100) NULL\n\t\t\t \n\t\t)\t\t\n\n\t\tINSERT INTO #factclaimdetails\n\t\t(\n\t\t  [ClaimFIRNo] \n\t\t, [ClaimType] \n\t\t, [AmountBilled] \n\t\t, [AmountNet] \n\t\t, [AmountPaid] \t\n\t\t, [HospitalId] \n\t\t, [DatePaid] \n\t\t--, [DateReceived]\n\t\t, [DateofAdmit] \t\n\t\t, [DateofDocumentation] \n\t\t, [DateofDischarge] \n\t\t, [DateModified] \n\t\t, [MemberDetailId] \n\t\t, [Corporate] \n\t\t, [Diagnosis]\n\t\t, [Procedure]\n\t\t \n\t\t)\n\t\t\t\t\n\n\t\tSELECT\n\t\n\t\t\tET.BILL_NO\t\t\t\t\t\t\tClaimFIRNo \t\n\t\t,\tCASE \n\t\t\t\tWHEN ET.Claim_Type = '''+@ClaimType+''' THEN 0 \n\t\t\t\tELSE 1 END\t\t\t\t\t\t \n\t\t,\tET.[Claimed Amount]\t\t\t\t\tAmountBilled\n\t\t,\tET.[Claimed Amount]\t\t\t\t\tAmountNet\n\t\t,\tET.[Transferred Amount]\t\t\t\tAmountPaid\n\t\t,\tH.HospitalId\t\t\t\t\t\tHospitalId\n\t\t,\tCONVERT(DATETIME,LEFT(ET.[Transferred Date],10))\t\t\t\tDatePaid\n\t\t--,\tCONVERT(DATETIME,LEFT(ET.[Transferred Date],10))\t\t\t\tDateReceived\n\t\t,\tCONVERT(DATETIME,LEFT(ET.[Loss_Date],10))\t\t\t\t\t\tDateofAdmin\n\t\t,\tCONVERT(DATETIME,LEFT(ET.[Date of last document received],10))\tDateofDocumentation\n\t\t,\tCONVERT(DATETIME,LEFT(ET.[Date of Discharge],10))\t\t\t\tDateofDischarge\n\t\t,\tCONVERT(DATETIME,LEFT(ET.[Date Modified],10))\t\t\t\t\tDateModified\n\t\t,\tMD.Member_Detail_id\t\t\t\t\tMemberDetailId\t\n\t\t,\tET.[Group name]\t\t\t\t\t\tCorporate\n\t\t,\tET.[Disease Description]\n\t\t,\tET.[Procedure Description]\n\t\t \n\t\n\t\tFROM load.EXTERNALTPADATA ET\n\t\tLEFT OUTER JOIN Factclaimdetails F ON ET.BILL_NO = F.ClaimFIRNo AND F.IsExternalTPAClaim = 1\n\t\tLEFT OUTER JOIN DimHospitalDetails H ON ET.[Provider Name] = H.HospitalName\n\t\tLEFT OUTER JOIN DimMembers M ON M.Member_code = ET.Member_ID AND M.[IsExternalTPA] = 1\n\t\tLEFT OUTER JOIN DimMemberDetails MD ON MD.member_Id = M.member_Id and MD.PolicyNo = ET.Policy_No AND MD.[IsExternalTPA] = 1\n\t\tWHERE\n\t\t\tF.Claimformdetailid IS NULL\n\n\t\tINSERT INTO factclaimdetails\n\t\t(\n\t\t  [ClaimFIRNo] \n\t\t, [ClaimType] \n\t\t, [AmountBilled] \n\t\t, [AmountNet] \n\t\t, [AmountPaid] \t\n\t\t, [HospitalId] \n\t\t, [DatePaid] \t\t \n\t\t, [DateofAdmit] \t\n\t\t, [DateofDocumentation] \n\t\t, [DateofDischarge] \n\t\t, [DateModified] \n\t\t, [MemberDetailId] \n\t\t, [Corporate] \n\t\t, [IsExternalTPAClaim]\n\t\t)\n\t\tSELECT \n\t\t \n\t\t  [ClaimFIRNo] \n\t\t, [ClaimType] \n\t\t, [AmountBilled] \n\t\t, [AmountNet] \n\t\t, [AmountPaid] \t\n\t\t, [HospitalId] \n\t\t, [DatePaid] \n\t  \n\t\t, [DateofAdmit] \t\n\t\t, [DateofDocumentation] \n\t\t, [DateofDischarge] \n\t\t, [DateModified] \n\t\t, [MemberDetailId] \n\t\t, [Corporate] \n\t\t, 1\n\t\t\n\t\tFROM #factclaimdetails\n\n\t\t\n\t\tINSERT INTO [dbo].[LnkClaimDiagnosisCodes]\n\t\t(\n\t\t\tIcdCodeId\n\t\t,\tClaimFormDetailId\n\t\t)\n\t\tSELECT \n\t\t\tD.IcdCodeId\n\t\t,\tF.ClaimFormDetailId\n\t\t \n\t\tFROM #FactClaimDetails F\n\t\tLEFT OUTER JOIN LnkClaimDiagnosisCodes L ON L.ClaimFormDetailId = F.ClaimformDetailId\n\t\tINNER JOIN dbo.DimDiagnosisCodes D ON D.IcdDescription = F.[Diagnosis]\n\t\tWHERE\n\t\t\tL.ClaimDiagnosisId IS NULL\n\n\n\t\tINSERT INTO [dbo].[LnkClaimProcedureDetails]\n\t\t(\n\t\t\tIcdCodeId\n\t\t,\tClaimFormDetailId\n\t\t)\n\t\tSELECT \n\t\t\tD.CptCodeId\n\t\t,\tF.ClaimFormDetailId\n\t\t  \n\t\tFROM #FactClaimDetails F\n\t\tLEFT OUTER JOIN LnkClaimProcedureDetails L ON L.ClaimFormDetailId = F.ClaimformDetailId\n\t\tINNER JOIN dbo.DimProcedureCodes D ON D.CptDescription = F.[Procedure]\n\t\tWHERE\n\t\t\tL.ClaimProcedureId IS NULL\n\t\t\n\t\tDROP TABLE #DimMembers\t\t\n\t\tDROP TABLE #DimMemberDetails\n\t\tDROP TABLE #factclaimdetails\n\t\t\t'\n\t\t\n        Select @s1",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "ClaimsSummaryDSQL",
				"databaseName": "ClaimsSummaryDSQL"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}